pipeline {
  agent { label 'nix' }

  triggers {
    pollSCM('H/5 * * * *')
  }

  stages {
    stage('prepare') {
      steps {
        sh "nix --version"
      }
    }

    stage('check') {
      steps {
        dir("test") {
          // unfeasible at the moment :(
          // sh "nix flake check . --quiet --no-write-lock-file"
          script {
            def flakeJson = sh(returnStdout: true, script: 'nix flake show --json')
            def flake = readJSON(text: flakeJson)
            flake.checks."x86_64-linux".each { name, _ ->
              sh "nix build .#checks.\"x86_64-linux\".${name} --quiet --no-write-lock-file"
            }
          }
        }
      }
    }

    stage('build') {
      steps {
        script {
          def flakeJson = sh(returnStdout: true, script: 'nix flake show --json')
          def flake = readJSON(text: flakeJson)
          flake.packages."x86_64-linux".each { name, _ ->
            sh "nix build .#${name} --quiet --no-write-lock-file"
          }
        }
      }
    }
  }
}
