pipeline {
	agent { label 'nix' }

	triggers {
		pollSCM('H/5 * * * *')
	}

	stages {
		stage('build') {
			def flakeJson = sh(returnStdout: true, script: 'nix flake show --json')
			def flake = readJSON text: flakeJson
			flake.packages.'x86_64-linux'.each { key value ->
				echo "building ${key}"
			}
		}
	}
}
